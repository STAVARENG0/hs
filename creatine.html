<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Creatine — Store</title>
  <style>
    :root{--bg:#0b0c10;--card:#121318;--muted:#9aa0a6;--text:#e8eaed;--accent:#18a999;--accent-2:#2bd4c4;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0b0f, #0f1117);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(10,12,17,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-weight:700;letter-spacing:.3px;font-size:22px}
    .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;font-size:12px;color:var(--muted)}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);outline:none;background:#0d0f14;color:var(--text)}
    .search input::placeholder{color:#80868b}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,#12141c,#0e1117);color:var(--text);text-decoration:none;font-weight:600;cursor:pointer}
    .btn.disabled{opacity:.5;pointer-events:none}
    main{padding:20px 0}
    #products{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px}
    @media(min-width:640px){#products{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:960px){#products{grid-template-columns:repeat(3,minmax(0,1fr))}}
    article.product{position:relative;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#0f1116,#0b0d12);border-radius:16px;overflow:hidden}
    article.product img{width:100%;height:220px;object-fit:cover;background:#0f1116;display:block}
    .product-body{padding:12px 14px}
    .product-body h3{margin:.2rem 0 .4rem;font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .price{font-weight:800;font-size:18px;margin-top:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .cta{display:flex;gap:10px;padding:12px 14px;border-top:1px dashed rgba(255,255,255,.06)}
    footer{border-top:1px solid rgba(255,255,255,.06);color:var(--muted)}
    .oos-ribbon{position:absolute;top:10px;left:-10px;background:linear-gradient(90deg,#6b7280,#9ca3af);color:#0b0c10;padding:6px 12px;transform:skewX(-12deg);font-size:11px;font-weight:800;border-radius:6px}
    .empty{padding:28px;text-align:center;border:1px dashed rgba(255,255,255,.12);border-radius:12px;background:#0d1016}
    .breadcrumbs{font-size:12px;color:var(--muted);margin-top:6px}
    .breadcrumbs a{color:var(--muted);text-decoration:none}
    .breadcrumbs a:hover{color:var(--text)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row" role="navigation" aria-label="Breadcrumb">
        <h1>Creatine</h1>
        <span class="pill">Category page</span>
        <div class="breadcrumbs"> <a href="./index.html">Home</a> · <strong>Creatine</strong> </div>
        <div class="search" style="margin-left:auto;min-width:260px">
          <input id="search" type="search" placeholder="Buscar na categoria (título, marca)..." oninput="searchProducts()">
          <button class="btn" onclick="clearSearch()" title="Limpar busca">Limpar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="products" aria-live="polite"></div>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <div>© <span id="year"></span> — Category: <strong>Creatine</strong></div>
      <div class="meta">Arquivos: products.json</div>
    </div>
  </footer>

<script>
/** CONFIG **/
const CATEGORY = 'Creatine';           // categoria desta página (deve ser idêntica ao que o painel salva)
const PUBLIC_JSON = './products.json'; // caminho do JSON público com produtos

/** DOM **/
const grid = document.getElementById('products');
let currentList = []; // itens já filtrados pela categoria

/** Safe no-op para evitar erro se site global não existir */
window.updateCartIcon = window.updateCartIcon || function(){};

/** Helpers **/
function sanitizeList(list){
  if(!Array.isArray(list)) return [];
  return list.map(p => ({
    id: p.id || (typeof crypto!=='undefined' && crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)),
    title: String(p.title || ''),
    brand: String(p.brand || ''),
    price: Number(p.price || 0),
    image: p.image || '5.png',
    description: String(p.description || ''),
    gallery: Array.isArray(p.gallery) ? p.gallery : [],
    category: String(p.category || ''),
    createdAt: p.createdAt || 0,
    stock: typeof p.stock === 'number' ? p.stock : parseInt(p.stock || '0', 10)
  }));
}

async function readPublic(){
  try{
    const r = await fetch(PUBLIC_JSON + '?t=' + Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    return sanitizeList(data);
  }catch(e){
    console.error('readPublic error', e);
    return [];
  }
}

function productCard(p){
  const el = document.createElement('article');
  el.className = 'product';

  if(Number(p.stock) <= 0){
    const badge = document.createElement('div');
    badge.className = 'oos-ribbon';
    badge.textContent = 'OUT OF STOCK';
    el.appendChild(badge);
  }

  const img = document.createElement('img');
  img.src = p.image;
  img.alt = p.title || 'Product image';
  img.loading = 'lazy';
  el.appendChild(img);

  const body = document.createElement('div');
  body.className = 'product-body';
  const brand = p.brand ? `<div class="meta">${p.brand}</div>` : '';
  body.innerHTML = `
    <h3>${p.title}</h3>
    ${brand}
    <div class="meta">Stock: ${Number.isFinite(p.stock) ? p.stock : 0}</div>
    <div class="price">€ ${Number(p.price || 0).toFixed(2)}</div>
  `;
  el.appendChild(body);

  const cta = document.createElement('div'); cta.className = 'cta';
  const a = document.createElement('a'); a.className = 'btn'; a.href = '#';
  if(Number(p.stock) > 0){
    a.textContent = 'Add to Cart';
    a.dataset.action = 'add-to-cart';
    a.dataset.id = p.id;
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      // Integração simples de carrinho (gatilho)
      alert('Added to cart: ' + (p.title || 'Product'));
      updateCartIcon();
    });
  }else{
    a.textContent = 'Out of Stock';
    a.classList.add('disabled');
  }
  cta.appendChild(a);
  el.appendChild(cta);

  return el;
}

function render(list){
  grid.innerHTML = '';
  if(!list.length){
    grid.innerHTML = '<div class="empty">Nenhum produto disponível nesta categoria.</div>';
    return;
  }
  const frag = document.createDocumentFragment();
  list.forEach(p => frag.appendChild(productCard(p)));
  grid.appendChild(frag);
}

/** Busca apenas dentro da categoria atual **/
function searchProducts(){
  const term = document.getElementById('search').value.trim().toLowerCase();
  if(!term) { render(currentList); return; }
  const filtered = currentList.filter(p =>
    (p.title && p.title.toLowerCase().includes(term)) ||
    (p.brand && p.brand.toLowerCase().includes(term))
  );
  render(filtered);
}

function clearSearch(){
  const input = document.getElementById('search');
  input.value = '';
  render(currentList);
  input.focus();
}

/** Init **/
(async function init(){
  const all = await readPublic();
  currentList = all.filter(p => (p.category || '').toLowerCase() === CATEGORY.toLowerCase());
  // ordem: mais novos primeiro (se createdAt existir)
  currentList.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  render(currentList);
  document.getElementById('year').textContent = new Date().getFullYear();
  updateCartIcon();
})();
</script>
</body>
</html>
